/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    dbcan-nf Slurm executor configuration for HPC clusters
    Based on UNL HCC and nf-core best practices
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

process {
    executor = 'slurm'
    queue = 'batch'  // Adjust according to your cluster: may be 'batch', 'compute', 'normal', etc.
    cpus = { 1 * task.attempt }
    memory = { 6.GB * task.attempt }
    time = { 4.h * task.attempt }
    
    // Error handling strategy
    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries = 1
    maxErrors = '-1'
    
    // Use scratch space to improve I/O performance (if available)
    scratch = '/scratch/$USER/$SLURM_JOB_ID'
    
    // Resource limits - prevent requesting excessive resources
    resourceLimits = [
        cpus: 32,
        memory: 128.GB,
        time: 7.d
    ]
    
    // Process-specific resource configurations (inherited from base.config)
    withLabel:process_single {
        cpus   = { 1 }
        memory = { 8.GB * task.attempt }
        time   = { 8.h * task.attempt }
    }
    withLabel:process_low {
        cpus   = { 2 * task.attempt }
        memory = { 12.GB * task.attempt }
        time   = { 4.h * task.attempt }
    }
    withLabel:process_medium {
        cpus   = { 6 * task.attempt }
        memory = { 36.GB * task.attempt }
        time   = { 8.h * task.attempt }
    }
    withLabel:process_high {
        cpus   = { 12 * task.attempt }
        memory = { 72.GB * task.attempt }
        time   = { 16.h * task.attempt }
    }
    withLabel:process_long {
        time   = { 20.h * task.attempt }
    }
    withLabel:process_high_memory {
        memory = { 200.GB * task.attempt }
    }
}

executor {
    name = 'slurm'
    queueSize = 50              // Limit number of simultaneously submitted tasks
    submitRateLimit = '5 sec'    // Submit one task every 5 seconds to avoid overwhelming the scheduler
    pollInterval = '1 min'       // Polling interval
    queueStatInterval = '5 min'  // Queue status check interval
}

singularity {
    enabled = true
    autoMounts = true
    cacheDir = '/work/$USER/.singularity_cache'
    // Uncomment and modify if you need to bind specific directories
    // runOptions = '--bind /work:/work --bind /scratch:/scratch'
}

// Work directory settings
workDir = '/work/$USER/nf-work'

// Reports and timeline
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline_${params.trace_report_suffix}.html"
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report_${params.trace_report_suffix}.html"
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace_${params.trace_report_suffix}.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag_${params.trace_report_suffix}.html"
}

// Parameter descriptions
params {
    config_profile_name = 'slurm'
    config_profile_description = 'Slurm executor configuration for HPC clusters (UNL HCC compatible)'
    config_profile_contact = 'yourname@unl.edu'  // Modify with your email address
}
